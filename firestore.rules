rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Orders collection ==========
    match /orders/{orderId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||       // العميل يقرأ طلباته
        resource.data.status == "pending" ||              // السائق يقرأ الطلبات الجديدة
        resource.data.status == "accepted" ||             // السائق يقرأ الطلبات المقبولة
        resource.data.driverId == request.auth.uid ||     // السائق يقرأ طلباته
        request.auth.token.accountant == true             // المحاسب يقرأ الكل
      );

      // العميل ينشئ طلب
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;

      // السائق أو المحاسب يحدث حالة الطلب
      allow update: if request.auth != null && (
        (resource.data.status == "pending" || resource.data.status == "accepted") ||
        (request.resource.data.status in ["ready", "accepted", "in_progress", "completed"]) ||
        ("driverId" in request.resource.data && request.resource.data.driverId == request.auth.uid) ||
        request.auth.token.accountant == true
      );

      // فقط المحاسب يحذف الطلب
      allow delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }

    // ========== Users collection ==========
    match /users/{userId} {
      allow create, read, update: if request.auth != null &&
        request.auth.uid == userId;

      allow read, delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }

    // ========== Drivers collection ==========
    match /drivers/{driverId} {
      allow read, update: if request.auth != null &&
        request.auth.uid == driverId;

      allow read, create, delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }

    // ========== Offers collection ==========
    match /offers/{offerId} {
      allow read: if true; // الكل يقدر يشوف العروض

      // فقط المحاسب يقدر يعدل ويضيف ويحذف عروض
      allow create, update, delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }
  }
}
