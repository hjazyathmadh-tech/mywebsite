rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Orders collection ==========
    match /orders/{orderId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||       // العميل يقرأ طلباته
        resource.data.status == "pending" ||              // السائق يقرأ الطلبات الجديدة
        resource.data.driverId == request.auth.uid ||     // السائق يقرأ طلباته
        request.auth.token.accountant == true             // المحاسب يقرأ الكل
      );

      // العميل ينشئ طلب
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;

      // السائق يقدر يحدث حالة الطلب الخاص فيه
      allow update: if request.auth != null && (
        // قبول الطلب
        (resource.data.status == "pending" &&
         request.resource.data.status == "accepted" &&
         request.resource.data.driverId == request.auth.uid) ||

        // بدء التوصيل
        (resource.data.driverId == request.auth.uid &&
         resource.data.status == "accepted" &&
         request.resource.data.status == "in_progress") ||

        // إنهاء الطلب
        (resource.data.driverId == request.auth.uid &&
         resource.data.status == "in_progress" &&
         request.resource.data.status == "completed") ||

        // المحاسب يعدل الكل
        request.auth.token.accountant == true
      );

      // فقط المحاسب يحذف
      allow delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }

    // ========== Users collection ==========
    match /users/{userId} {
      allow read, update: if request.auth != null &&
        request.auth.uid == userId;

      allow read, create, delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }

    // ========== Drivers collection ==========
    match /drivers/{driverId} {
      allow read, update: if request.auth != null &&
        request.auth.uid == driverId;

      allow read, create, delete: if request.auth != null &&
        request.auth.token.accountant == true;
    }
  }
}
